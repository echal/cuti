{% extends 'base.html.twig' %}

{% block title %}Ubah Password{% endblock %}

{% block body %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-key"></i>
        Ubah Password
    </h1>
    
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ path('profile_show') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Kembali
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock"></i>
                    Keamanan Password
                </h5>
            </div>
            <div class="card-body">
                {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
                
                <div class="mb-4">
                    {{ form_label(form.currentPassword) }}
                    {{ form_widget(form.currentPassword, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.currentPassword) }}
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i>
                        Masukkan password saat ini untuk verifikasi
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    {{ form_label(form.newPassword.first) }}
                    {{ form_widget(form.newPassword.first, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.newPassword.first) }}
                    {{ form_help(form.newPassword.first) }}
                </div>
                
                <div class="mb-4">
                    {{ form_label(form.newPassword.second) }}
                    {{ form_widget(form.newPassword.second, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.newPassword.second) }}
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ path('profile_show') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Batal
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-shield-check"></i> Ubah Password
                    </button>
                </div>
                
                {{ form_end(form) }}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-shield-exclamation"></i>
                    Tips Keamanan Password
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>Password yang Aman:</strong>
                    <ul class="mb-0 mt-2 small">
                        <li>Minimal 6 karakter</li>
                        <li>Kombinasi huruf dan angka</li>
                        <li>Gunakan simbol jika memungkinkan</li>
                        <li>Hindari informasi pribadi</li>
                        <li>Jangan gunakan password yang sama di tempat lain</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h6 class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Penting!
                    </h6>
                    <small class="text-muted">
                        Setelah mengubah password, Anda akan tetap login pada sesi ini, 
                        tetapi harus menggunakan password baru untuk login berikutnya.
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Riwayat Keamanan
                </h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>Terakhir login:</strong><br>
                    {{ "now"|date("d/m/Y H:i") }}<br><br>
                    
                    <strong>Akun dibuat:</strong><br>
                    {% if app.user.createdAt %}
                        {{ app.user.createdAt|date("d/m/Y") }}
                    {% else %}
                        Data tidak tersedia
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const currentPasswordField = document.getElementById('change_password_currentPassword');
    const newPasswordField = document.getElementById('change_password_newPassword_first');
    const confirmPasswordField = document.getElementById('change_password_newPassword_second');
    
    // Password strength indicator
    if (newPasswordField) {
        const strengthIndicator = document.createElement('div');
        strengthIndicator.className = 'mt-1';
        newPasswordField.parentNode.appendChild(strengthIndicator);
        
        newPasswordField.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            let message = '';
            
            if (password.length >= 6) strength += 1;
            if (password.match(/[a-z]/)) strength += 1;
            if (password.match(/[A-Z]/)) strength += 1;
            if (password.match(/[0-9]/)) strength += 1;
            if (password.match(/[^a-zA-Z0-9]/)) strength += 1;
            
            switch(strength) {
                case 0:
                case 1:
                    message = '<small class="text-danger">Password sangat lemah</small>';
                    break;
                case 2:
                    message = '<small class="text-warning">Password lemah</small>';
                    break;
                case 3:
                    message = '<small class="text-info">Password sedang</small>';
                    break;
                case 4:
                    message = '<small class="text-success">Password kuat</small>';
                    break;
                case 5:
                    message = '<small class="text-success"><strong>Password sangat kuat</strong></small>';
                    break;
            }
            
            strengthIndicator.innerHTML = message;
        });
    }
    
    // Form validation
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!currentPasswordField.value) {
                e.preventDefault();
                alert('Password saat ini harus diisi!');
                currentPasswordField.focus();
                return false;
            }
            
            if (newPasswordField.value.length < 6) {
                e.preventDefault();
                alert('Password baru minimal 6 karakter!');
                newPasswordField.focus();
                return false;
            }
            
            if (newPasswordField.value !== confirmPasswordField.value) {
                e.preventDefault();
                alert('Konfirmasi password tidak sama!');
                confirmPasswordField.focus();
                return false;
            }
            
            if (currentPasswordField.value === newPasswordField.value) {
                e.preventDefault();
                alert('Password baru harus berbeda dengan password saat ini!');
                newPasswordField.focus();
                return false;
            }
        });
    }
    
    // Show/hide password toggle
    function addPasswordToggle(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            const wrapper = document.createElement('div');
            wrapper.className = 'input-group';
            field.parentNode.insertBefore(wrapper, field);
            wrapper.appendChild(field);
            
            const button = document.createElement('button');
            button.className = 'btn btn-outline-secondary';
            button.type = 'button';
            button.innerHTML = '<i class="bi bi-eye"></i>';
            button.onclick = function() {
                if (field.type === 'password') {
                    field.type = 'text';
                    this.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    field.type = 'password';
                    this.innerHTML = '<i class="bi bi-eye"></i>';
                }
            };
            
            const appendDiv = document.createElement('div');
            appendDiv.className = 'input-group-append';
            appendDiv.appendChild(button);
            wrapper.appendChild(appendDiv);
        }
    }
    
    addPasswordToggle('change_password_currentPassword');
    addPasswordToggle('change_password_newPassword_first');
    addPasswordToggle('change_password_newPassword_second');
});
</script>
{% endblock %}